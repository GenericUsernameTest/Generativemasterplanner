<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Generative Masterplanner - 40 Homes/ha + 3D Basemap</title>
  <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no" />

  <!-- Mapbox GL JS -->
  <script src="https://api.mapbox.com/mapbox-gl-js/v3.14.0/mapbox-gl.js"></script>
  <link href="https://api.mapbox.com/mapbox-gl-js/v3.14.0/mapbox-gl.css" rel="stylesheet" />

  <!-- Turf + Draw -->
  <script src="https://unpkg.com/@turf/turf@6/turf.min.js"></script>
  <script src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-draw/v1.5.0/mapbox-gl-draw.js"></script>
  <link rel="stylesheet" href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-draw/v1.5.0/mapbox-gl-draw.css" />

  <style>
    body { margin:0; padding:0; }
    #map { position:absolute; inset:0; }
    .info-box {
      position:absolute; bottom:30px; left:20px;
      background:#fff; padding:15px; font:14px/1.4 sans-serif;
      border-radius:6px; box-shadow:0 1px 3px rgba(0,0,0,.25);
    }
    .info-box strong { font-size:16px; }
  </style>
</head>
<body>
<div id="map"></div>
<div class="info-box" id="stats">
  <p><strong>Draw a polygon</strong> to place homes (40/ha). Each home is 7×7 m.</p>
</div>

<script>
mapboxgl.accessToken = 'pk.eyJ1IjoiYXNlbWJsIiwiYSI6ImNtZTMxcG90ZzAybWgyanNjdmdpbGZkZHEifQ.3XPuSVFR0s8kvnRnY1_2mw';

const map = new mapboxgl.Map({
  container: 'map',
  style: 'mapbox://styles/mapbox/light-v11',
  center: [-0.13, 51.505],
  zoom: 16,
  pitch: 60,          // tilt so 3D is visible
  bearing: -15,
  projection: 'globe' // natural globe
});

map.addControl(new mapboxgl.NavigationControl());

/* ---------- ENABLE 3D BASEMAP (terrain + buildings) ---------- */
map.on('style.load', () => {
  // Sky/fog for depth
  map.setFog({});

  // Terrain (DEM)
  map.addSource('mapbox-dem', {
    type: 'raster-dem',
    url: 'mapbox://mapbox.terrain-rgb',
    tileSize: 512,
    maxzoom: 14
  });
  map.setTerrain({ source: 'mapbox-dem', exaggeration: 1.2 });

  // Insert 3D buildings for light-v11
  // Find the first symbol layer with text to place buildings beneath labels
  const layers = map.getStyle().layers;
  let labelLayerId = null;
  for (const l of layers) {
    if (l.type === 'symbol' && l.layout && l.layout['text-field']) {
      labelLayerId = l.id; break;
    }
  }

  if (!map.getLayer('add-3d-buildings')) {
    map.addLayer({
      id: 'add-3d-buildings',
      source: 'composite',
      'source-layer': 'building',
      filter: ['==', 'extrude', 'true'],
      type: 'fill-extrusion',
      minzoom: 15,
      paint: {
        'fill-extrusion-color': '#aaa',
        'fill-extrusion-height': ['coalesce', ['get', 'height'], 5],
        'fill-extrusion-base': ['coalesce', ['get', 'min_height'], 0],
        'fill-extrusion-opacity': 0.6
      }
    }, labelLayerId || undefined);
  }

  // Your homes source/layer (3
